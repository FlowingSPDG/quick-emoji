name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # CI: „Åô„Åπ„Å¶„ÅÆ„Éñ„É©„É≥„ÉÅ„Å®PR„ÅßÂÆüË°å„Åï„Çå„ÇãÂÖ±ÈÄöÂá¶ÁêÜ
  # ============================================
  ci:
    name: CI (Test, Lint, Type Check, Build)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: Lint
        run: npm run lint

      - name: Run unit tests (Web)
        run: npm run test --workspace=apps/web

      - name: Run unit tests (API)
        run: npm run test --workspace=apps/api

      - name: Build API (verification)
        run: |
          cd apps/api
          npm run type-check
        continue-on-error: false

      - name: Build Web (verification)
        run: |
          cd apps/web
          npm run type-check
          # „Éì„É´„ÉâÊ§úË®ºÔºàÂÆüÈöõ„ÅÆ„Éá„Éó„É≠„Ç§„ÅØ„Åó„Å™„ÅÑÔºâ
          NEXT_PUBLIC_API_URL=https://quick-emoji-api.example.workers.dev npm run build
        continue-on-error: false

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: build-artifacts
          path: |
            apps/web/out
          retention-days: 1

  # ============================================
  # Deploy Preview: PRÊôÇ„ÅÆ„ÅøÂÆüË°å
  # ============================================
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [ci]
    if: github.event_name == 'pull_request'
    environment:
      name: preview-${{ github.event.number }}
      url: ${{ steps.deploy-web.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure API for Preview
        run: |
          cd apps/api
          # PreviewÁî®„ÅÆWorkerÂêç„Å´Â§âÊõ¥
          sed -i "s/name = \"quick-emoji-api\"/name = \"quick-emoji-api-preview-${{ github.event.number }}\"/" wrangler.toml
          # KV namespace IDs„ÇíË®≠ÂÆö
          sed -i "s/\${EMOJI_DATA_ID}/$EMOJI_DATA_ID/g" wrangler.toml
          sed -i "s/\${GAME_SESSIONS_ID}/$GAME_SESSIONS_ID/g" wrangler.toml
          sed -i "s/\${LEADERBOARD_ID}/$LEADERBOARD_ID/g" wrangler.toml
        env:
          EMOJI_DATA_ID: ${{ secrets.EMOJI_DATA }}
          GAME_SESSIONS_ID: ${{ secrets.GAME_SESSIONS }}
          LEADERBOARD_ID: ${{ secrets.LEADERBOARD }}

      - name: Deploy API to Cloudflare Workers (Preview)
        id: deploy-api
        run: |
          set -e
          cd apps/api
          WORKER_NAME="quick-emoji-api-preview-${{ github.event.number }}"

          echo "Deploying API preview: ${WORKER_NAME}"
          DEPLOY_OUTPUT=$(npx wrangler deploy 2>&1) || {
            EXIT_CODE=$?
            echo "‚ö†Ô∏è Deploy command failed with exit code: $EXIT_CODE"
            echo "Deploy output:"
            echo "$DEPLOY_OUTPUT"
            exit $EXIT_CODE
          }

          echo "$DEPLOY_OUTPUT"

          # Extract URL from wrangler output
          API_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*\.workers\.dev' | head -1 || echo "")
          if [ -z "$API_URL" ]; then
            echo "‚ùå Could not extract API URL from output"
            exit 1
          fi

          echo "url=$API_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ API deployed to: $API_URL"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Build Web for Preview
        run: |
          cd apps/web
          NEXT_PUBLIC_API_URL=${{ steps.deploy-api.outputs.url }} npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.deploy-api.outputs.url }}

      - name: Verify build output
        run: |
          if [ ! -d "apps/web/out" ]; then
            echo "‚ùå ERROR: apps/web/out directory does not exist!"
            exit 1
          fi
          echo "‚úÖ Build output verified"

      - name: Deploy Web to Cloudflare Pages (Preview)
        id: deploy-web
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy apps/web/out --project-name=quick-emoji --branch=pr-${{ github.event.number }}

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const apiUrl = '${{ steps.deploy-api.outputs.url }}';
            const deployWebUrl = '${{ steps.deploy-web.outputs.url }}';
            const webUrl = deployWebUrl || 'https://quick-emoji.pages.dev';
            
            const body = `## üöÄ Preview Deployment
            
            ‚úÖ **API deployed to:** ${apiUrl}
            ‚úÖ **Frontend deployed to:** ${webUrl}
            
            You can test the preview deployment using the links above.
            
            ---
            *This preview will be automatically deleted when the PR is closed.*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ============================================
  # Deploy Development: develop„Éñ„É©„É≥„ÉÅ
  # ============================================
  deploy-development:
    name: Deploy Development
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: ci
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure API for Development
        run: |
          cd apps/api
          # DevelopmentÁî®„ÅÆWorkerÂêç„Å´Â§âÊõ¥
          sed -i "s/name = \"quick-emoji-api\"/name = \"quick-emoji-api-development\"/" wrangler.toml
          # KV namespace IDs„ÇíË®≠ÂÆö
          sed -i "s/\${EMOJI_DATA_ID}/$EMOJI_DATA_ID/g" wrangler.toml
          sed -i "s/\${GAME_SESSIONS_ID}/$GAME_SESSIONS_ID/g" wrangler.toml
          sed -i "s/\${LEADERBOARD_ID}/$LEADERBOARD_ID/g" wrangler.toml
        env:
          EMOJI_DATA_ID: ${{ secrets.EMOJI_DATA }}
          GAME_SESSIONS_ID: ${{ secrets.GAME_SESSIONS }}
          LEADERBOARD_ID: ${{ secrets.LEADERBOARD }}

      - name: Deploy API to Cloudflare Workers (Development)
        id: deploy-api
        run: |
          set -e
          cd apps/api
          PREVIEW_NAME="quick-emoji-api-development"
          
          echo "Deploying API development: ${PREVIEW_NAME}"
          DEPLOY_OUTPUT=$(npx wrangler deploy --name "${PREVIEW_NAME}" --env="" 2>&1) || {
            EXIT_CODE=$?
            echo "‚ö†Ô∏è Deploy command failed with exit code: $EXIT_CODE"
            echo "Deploy output:"
            echo "$DEPLOY_OUTPUT"
            API_URL="https://${PREVIEW_NAME}.${CLOUDFLARE_ACCOUNT_ID}.workers.dev"
            echo "api_url=$API_URL" >> $GITHUB_OUTPUT
            echo "Using fallback API URL: $API_URL"
            exit 0
          }
          
          # Extract URL from output if deploy succeeded
          if [ -z "${API_URL:-}" ]; then
            echo "$DEPLOY_OUTPUT"
            API_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*\.workers\.dev' | head -1 || echo "")
            if [ -z "$API_URL" ]; then
              echo "‚ö†Ô∏è Could not extract API URL from output, using fallback"
              API_URL="https://${PREVIEW_NAME}.${CLOUDFLARE_ACCOUNT_ID}.workers.dev"
            fi
            echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          fi
          
          echo "‚úÖ API development deployed to: $API_URL"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          EMOJI_DATA_ID: ${{ secrets.EMOJI_DATA }}
          GAME_SESSIONS_ID: ${{ secrets.GAME_SESSIONS }}
          LEADERBOARD_ID: ${{ secrets.LEADERBOARD }}

      - name: Build Web for Development
        run: |
          cd apps/web
          echo "Building with NEXT_PUBLIC_API_URL: ${{ steps.deploy-api.outputs.api_url }}"
          NEXT_PUBLIC_API_URL=${{ steps.deploy-api.outputs.api_url }} npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.deploy-api.outputs.api_url }}

      - name: Verify build output
        run: |
          if [ ! -d "apps/web/out" ]; then
            echo "‚ùå ERROR: apps/web/out directory does not exist!"
            exit 1
          fi
          echo "‚úÖ Build output verified"

      - name: Deploy Web to Cloudflare Pages (Development)
        id: deploy-web
        run: |
          set -e
          echo "üöÄ Deploying to Cloudflare Pages..."
          echo "Project name: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}"
          echo "Branch: develop"
          echo "Directory: apps/web/out"
          
          if [ ! -d "apps/web/out" ]; then
            echo "‚ùå ERROR: apps/web/out directory does not exist!"
            exit 1
          fi
          
          DEPLOY_OUTPUT=$(npx wrangler pages deploy apps/web/out \
            --project-name="${{ secrets.CLOUDFLARE_PROJECT_NAME }}" \
            --branch=develop \
            --commit-hash="${{ github.sha }}" \
            --commit-message="${{ github.event.head_commit.message }}" \
            2>&1) || {
            EXIT_CODE=$?
            echo "‚ùå Deploy failed with exit code: $EXIT_CODE"
            echo "Deploy output:"
            echo "$DEPLOY_OUTPUT"
            exit $EXIT_CODE
          }
          
          echo "$DEPLOY_OUTPUT"
          
          WEB_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*\.pages\.dev' | head -1 || echo "")
          if [ -z "$WEB_URL" ]; then
            WEB_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*\.cloudflarepages\.com' | head -1 || echo "")
          fi
          
          if [ -z "$WEB_URL" ]; then
            echo "‚ö†Ô∏è Could not extract deployment URL from output"
            WEB_URL="https://${{ secrets.CLOUDFLARE_PROJECT_NAME }}.pages.dev"
          fi
          
          echo "url=$WEB_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployment successful: $WEB_URL"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Create deployment notification
        uses: actions/github-script@v7
        with:
          script: |
            const apiUrl = '${{ steps.deploy-api.outputs.api_url }}';
            const webUrl = '${{ steps.deploy-web.outputs.url }}';
            
            const body = `## ‚úÖ Development Deployment Complete
            
            **API URL:** ${apiUrl}
            **Web URL:** ${webUrl}
            
            Deployed to development from commit: ${context.sha.substring(0, 7)}
            
            [View Deployment](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${context.sha})`;
            
            console.log(body);

  # ============================================
  # Deploy Production: main„Éñ„É©„É≥„ÉÅ
  # ============================================
  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [ci]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: ${{ steps.deploy-web.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure API for Production
        run: |
          cd apps/api
          # KV namespace IDs„ÇíË®≠ÂÆö
          sed -i "s/\${EMOJI_DATA_ID}/$EMOJI_DATA_ID/g" wrangler.toml
          sed -i "s/\${GAME_SESSIONS_ID}/$GAME_SESSIONS_ID/g" wrangler.toml
          sed -i "s/\${LEADERBOARD_ID}/$LEADERBOARD_ID/g" wrangler.toml
        env:
          EMOJI_DATA_ID: ${{ secrets.EMOJI_DATA }}
          GAME_SESSIONS_ID: ${{ secrets.GAME_SESSIONS }}
          LEADERBOARD_ID: ${{ secrets.LEADERBOARD }}

      - name: Deploy API to Cloudflare Workers (Production)
        id: deploy-api
        run: |
          set -e
          cd apps/api

          echo "Deploying API production..."
          DEPLOY_OUTPUT=$(npx wrangler deploy 2>&1) || {
            EXIT_CODE=$?
            echo "‚ö†Ô∏è Deploy command failed with exit code: $EXIT_CODE"
            echo "Deploy output:"
            echo "$DEPLOY_OUTPUT"
            exit $EXIT_CODE
          }

          echo "$DEPLOY_OUTPUT"

          # Extract URL from wrangler output
          API_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*\.workers\.dev' | head -1 || echo "")
          if [ -z "$API_URL" ]; then
            echo "‚ùå Could not extract API URL from output"
            exit 1
          fi

          echo "url=$API_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ API deployed to: $API_URL"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Build Web for Production
        run: |
          cd apps/web
          NEXT_PUBLIC_API_URL=${{ steps.deploy-api.outputs.url }} npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.deploy-api.outputs.url }}

      - name: Verify build output
        run: |
          if [ ! -d "apps/web/out" ]; then
            echo "‚ùå ERROR: apps/web/out directory does not exist!"
            exit 1
          fi
          echo "‚úÖ Build output verified"

      - name: Deploy Web to Cloudflare Pages (Production)
        id: deploy-web
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy apps/web/out --project-name=quick-emoji

      - name: Create deployment notification
        uses: actions/github-script@v7
        with:
          script: |
            const apiUrl = '${{ steps.deploy-api.outputs.url }}';
            const webUrl = '${{ steps.deploy-web.outputs.url }}' || 'https://quick-emoji.pages.dev';
            
            const body = `## üöÄ Production Deployment Complete
            
            ‚úÖ **API deployed to:** ${apiUrl}
            ‚úÖ **Frontend deployed to:** ${webUrl}
            
            Deployed from commit: ${context.sha.substring(0, 7)}
            
            [View Deployment](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${context.sha})`;
            
            console.log(body);
