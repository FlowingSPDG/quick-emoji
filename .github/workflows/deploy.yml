name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Run tests
      run: npm test

    - name: Deploy API to Cloudflare Workers
      id: deploy-api
      run: |
        cd apps/api
        echo "Verifying environment variables..."
        echo "CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID:0:8}..."
        echo "EMOJI_DATA_ID: ${EMOJI_DATA_ID}"
        echo "GAME_SESSIONS_ID: ${GAME_SESSIONS_ID}"
        echo "LEADERBOARD_ID: ${LEADERBOARD_ID}"
        # Use --env="" to explicitly target the top-level environment
        DEPLOY_OUTPUT=$(npx wrangler deploy --env="" 2>&1)
        echo "$DEPLOY_OUTPUT"
        # Extract URL from deploy output: https://quick-emoji-api.{subdomain}.workers.dev
        API_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*\.workers\.dev' | head -1 || echo "https://quick-emoji-api.${CLOUDFLARE_ACCOUNT_ID}.workers.dev")
        echo "api_url=$API_URL" >> $GITHUB_OUTPUT
        echo "Deployed API to: $API_URL"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        EMOJI_DATA_ID: ${{ secrets.KV_EMOJI_DATA_ID }}
        GAME_SESSIONS_ID: ${{ secrets.KV_GAME_SESSIONS_ID }}
        LEADERBOARD_ID: ${{ secrets.KV_LEADERBOARD_ID }}

    - name: Build web app
      run: npm run build
      env:
        NEXT_PUBLIC_API_URL: ${{ steps.deploy-api.outputs.api_url }}

    - name: Verify build output directory
      run: |
        if [ ! -d "apps/web/out" ]; then
          echo "âŒ ERROR: apps/web/out directory does not exist!"
          echo "Build may have failed. Checking for build errors..."
          ls -la apps/web/ || echo "apps/web directory not found"
          exit 1
        fi
        echo "âœ… Build output directory exists"
        echo "Contents of apps/web/out:"
        ls -la apps/web/out | head -20

    - name: Deploy to Cloudflare Pages
      id: deploy-web
      run: |
        set -e
        echo "ðŸš€ Deploying to Cloudflare Pages..."
        echo "Project name: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}"
        echo "Directory: apps/web/out"
        
        # Verify directory exists
        if [ ! -d "apps/web/out" ]; then
          echo "âŒ ERROR: apps/web/out directory does not exist!"
          exit 1
        fi
        
        # Deploy using wrangler
        DEPLOY_OUTPUT=$(npx wrangler pages deploy apps/web/out \
          --project-name="${{ secrets.CLOUDFLARE_PROJECT_NAME }}" \
          --commit-hash="${{ github.sha }}" \
          --commit-message="${{ github.event.head_commit.message }}" \
          2>&1) || {
          EXIT_CODE=$?
          echo "âŒ Deploy failed with exit code: $EXIT_CODE"
          echo "Deploy output:"
          echo "$DEPLOY_OUTPUT"
          exit $EXIT_CODE
        }
        
        echo "$DEPLOY_OUTPUT"
        
        # Extract deployment URL from output
        WEB_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*\.pages\.dev' | head -1 || echo "")
        if [ -z "$WEB_URL" ]; then
          # Try alternative URL format
          WEB_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*\.cloudflarepages\.com' | head -1 || echo "")
        fi
        
        if [ -z "$WEB_URL" ]; then
          echo "âš ï¸ Could not extract deployment URL from output"
          WEB_URL="https://${{ secrets.CLOUDFLARE_PROJECT_NAME }}.pages.dev"
        fi
        
        echo "url=$WEB_URL" >> $GITHUB_OUTPUT
        echo "âœ… Deployment successful: $WEB_URL"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Import emoji data
      run: |
        npm run import-data
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}