name: Deploy Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

concurrency:
  group: preview-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run type-check

      - name: Run lint
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Deploy API to preview
        id: deploy-api
        run: |
          set -e
          cd apps/api
          PR_NUMBER=${{ github.event.pull_request.number }}
          PREVIEW_NAME="quick-emoji-api-preview-${PR_NUMBER}"
          
          echo "Deploying API preview: ${PREVIEW_NAME}"
          DEPLOY_OUTPUT=$(npx wrangler deploy --name "${PREVIEW_NAME}" --env="" 2>&1) || {
            EXIT_CODE=$?
            echo "âš ï¸ Deploy command failed with exit code: $EXIT_CODE"
            echo "Deploy output:"
            echo "$DEPLOY_OUTPUT"
            
            # Fallback to default URL format
            API_URL="https://${PREVIEW_NAME}.${CLOUDFLARE_ACCOUNT_ID}.workers.dev"
            echo "api_url=$API_URL" >> $GITHUB_OUTPUT
            echo "Using fallback API URL: $API_URL"
          }
          
          # Extract URL from output if deploy succeeded
          if [ -z "${API_URL:-}" ]; then
            echo "$DEPLOY_OUTPUT"
            API_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*\.workers\.dev' | head -1 || echo "")
            if [ -z "$API_URL" ]; then
              echo "âš ï¸ Could not extract API URL from output, using fallback"
              API_URL="https://${PREVIEW_NAME}.${CLOUDFLARE_ACCOUNT_ID}.workers.dev"
            fi
            echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          fi
          
          echo "âœ… API preview deployed to: $API_URL"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          EMOJI_DATA_ID: ${{ secrets.KV_EMOJI_DATA_ID }}
          GAME_SESSIONS_ID: ${{ secrets.KV_GAME_SESSIONS_ID }}
          LEADERBOARD_ID: ${{ secrets.KV_LEADERBOARD_ID }}

      - name: Build web app for preview
        run: |
          cd apps/web
          echo "Building with NEXT_PUBLIC_API_URL: ${{ steps.deploy-api.outputs.api_url }}"
          npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.deploy-api.outputs.api_url }}

      - name: List Cloudflare Pages projects
        id: list-projects
        run: |
          echo "ðŸ“‹ Listing all Cloudflare Pages projects..."
          PROJECTS=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" | jq -r '.result[]?.name' || echo "")
          
          if [ -z "$PROJECTS" ]; then
            echo "âš ï¸ Could not fetch projects list or no projects found"
          else
            echo "Available projects:"
            echo "$PROJECTS" | while read -r project; do
              echo "  - $project"
            done
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Verify project name secret
        run: |
          PROJECT_NAME="${{ secrets.CLOUDFLARE_PROJECT_NAME }}"
          if [ -z "$PROJECT_NAME" ]; then
            echo "âŒ ERROR: CLOUDFLARE_PROJECT_NAME secret is not set!"
            echo ""
            echo "ðŸ“‹ To find your project name:"
            echo "1. Go to Cloudflare Dashboard: https://dash.cloudflare.com"
            echo "2. Navigate to: Workers & Pages > Pages"
            echo "3. Click on your project"
            echo "4. The project name is shown in the URL or project settings"
            echo ""
            echo "Or check the 'List Cloudflare Pages projects' step above for available projects."
            exit 1
          fi
          echo "âœ… CLOUDFLARE_PROJECT_NAME is set: $PROJECT_NAME"
          echo "Using project name: $PROJECT_NAME"

      - name: Deploy web app to preview
        id: deploy-web
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}
          directory: apps/web/out
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.head_ref }}

      - name: Comment preview URLs on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const apiUrl = '${{ steps.deploy-api.outputs.api_url }}';
            const webUrl = '${{ steps.deploy-web.outputs.url }}';
            
            const body = `## ðŸŽ‰ Preview Deployment Complete
            
            **API URL:** ${apiUrl}
            **Web URL:** ${webUrl}
            
            Preview environment for PR #${{ github.event.pull_request.number }}
            
            [View Changes](${context.payload.pull_request.html_url})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
